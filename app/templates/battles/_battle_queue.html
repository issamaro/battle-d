{# Battle Queue Partial - HTMX compatible for drag-and-drop reordering
   BR-SCHED-001: Battle queue interleaved across categories
   BR-SCHED-002: Battle reordering constraints (locked positions)
#}
<div id="battle-queue"
     class="battle-queue"
     hx-get="/battles/queue/{{ category.id }}"
     hx-trigger="every 5s"
     hx-swap="outerHTML"
     aria-label="Battle queue for {{ category.name }}">

    {# Active Battle (if any) #}
    {% if active_battle %}
    <section class="battle-queue-section" aria-label="Currently active battle">
        <h4 class="battle-queue-heading">Active Battle</h4>
        <article class="battle-card battle-active"
                 id="battle-{{ active_battle.id }}"
                 role="listitem"
                 aria-label="Active battle">
            <div class="lock-indicator" aria-label="Battle in progress (cannot be moved)">
                <span aria-hidden="true">*</span>
            </div>
            <div class="battle-card-content">
                <div class="battle-card-header">
                    <h4 class="battle-card-title">{{ active_battle.phase.value|title }}</h4>
                    <span class="badge badge-active" role="status">ACTIVE</span>
                </div>
                <div class="battle-identifier">
                    <span class="battle-performer-names">
                        {% for performer in active_battle.performers[:3] %}
                            {{ performer.dancer.dancer_name }}{% if not loop.last %} vs {% endif %}
                        {% endfor %}
                    </span>
                </div>
            </div>
            <div class="battle-card-footer">
                <a href="/battles/{{ active_battle.id }}/encode"
                   class="battle-action-btn battle-action-primary">
                    Encode Result
                </a>
            </div>
        </article>
    </section>
    {% endif %}

    {# Pending Battles Queue #}
    <section class="battle-queue-section" aria-label="Pending battles">
        <h4 class="battle-queue-heading">
            Battle Queue
            <span class="battle-count">({{ pending_battles|length }} pending)</span>
        </h4>

        {% if pending_battles %}
        <div id="sortable-battles"
             class="battle-list sortable-list"
             role="list"
             aria-label="Drag to reorder battles">
            {% for battle in pending_battles %}
            <article
                class="battle-card {% if loop.first %}battle-locked{% else %}battle-movable{% endif %}"
                id="battle-{{ battle.id }}"
                data-battle-id="{{ battle.id }}"
                data-position="{{ loop.index }}"
                role="listitem"
                aria-label="Battle {{ loop.index }}: {{ battle.performers|map(attribute='dancer.dancer_name')|join(' vs ') }}"
                {% if not loop.first %}draggable="true"{% endif %}>

                {# Drag Handle (only for movable battles) #}
                {% if not loop.first %}
                <div class="drag-handle"
                     aria-label="Drag to reorder"
                     tabindex="0"
                     role="button">
                    <span aria-hidden="true">||</span>
                </div>
                {% else %}
                <div class="lock-indicator" aria-label="Next battle is locked (cannot be moved)">
                    <span aria-hidden="true">NEXT</span>
                </div>
                {% endif %}

                {# Battle Content #}
                <div class="battle-card-content">
                    <div class="battle-card-header">
                        <span class="battle-position">{{ loop.index }}</span>
                        <h4 class="battle-card-title">{{ battle.phase.value|title }}</h4>
                        <span class="badge badge-pending" role="status">PENDING</span>
                    </div>
                    <div class="battle-identifier">
                        <span class="battle-performer-names">
                            {% for performer in battle.performers[:3] %}
                                {{ performer.dancer.dancer_name }}{% if not loop.last %} vs {% endif %}
                            {% endfor %}
                            {% if battle.performers|length > 3 %}
                                +{{ battle.performers|length - 3 }} more
                            {% endif %}
                        </span>
                    </div>
                </div>

                {# Actions #}
                <div class="battle-card-footer battle-actions">
                    {% if loop.first %}
                    <form action="/battles/{{ battle.id }}/start" method="post">
                        <button type="submit"
                                class="battle-action-btn battle-action-primary"
                                aria-label="Start this battle">
                            Start
                        </button>
                    </form>
                    {% endif %}
                    <a href="/battles/{{ battle.id }}"
                       class="battle-action-btn battle-action-secondary"
                       aria-label="View battle details">
                        Details
                    </a>
                </div>
            </article>
            {% endfor %}
        </div>

        {# Screen reader announcements for reorder #}
        <div id="reorder-status"
             role="status"
             aria-live="polite"
             class="sr-only">
        </div>

        {% else %}
        <p class="empty-queue">No pending battles in queue</p>
        {% endif %}
    </section>
</div>

{# Inline styles for battle queue (would normally be in CSS file) #}
<style>
.battle-queue {
    margin: 1rem 0;
}

.battle-queue-section {
    margin-bottom: 1.5rem;
}

.battle-queue-heading {
    font-size: 1.1rem;
    margin-bottom: 0.75rem;
    color: var(--color-text-secondary, #666);
}

.battle-count {
    font-weight: normal;
    font-size: 0.9rem;
}

.battle-list {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.battle-card {
    display: flex;
    align-items: center;
    padding: 0.75rem;
    border: 1px solid var(--color-border, #ddd);
    border-radius: 8px;
    background: var(--color-surface, #fff);
    transition: box-shadow 0.2s, transform 0.2s;
}

.battle-card.battle-active {
    border-color: var(--color-active, #f59e0b);
    background: var(--color-active-bg, #fffbeb);
}

.battle-card.battle-locked {
    border-color: var(--color-primary, #3b82f6);
    background: var(--color-primary-bg, #eff6ff);
}

.battle-card.battle-movable {
    cursor: grab;
}

.battle-card.battle-movable:hover {
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.battle-card.battle-movable.dragging {
    opacity: 0.5;
    cursor: grabbing;
}

.drag-handle {
    padding: 0.5rem;
    cursor: grab;
    color: var(--color-text-muted, #999);
    font-size: 1.2rem;
    line-height: 1;
    user-select: none;
}

.drag-handle:hover {
    color: var(--color-text, #333);
}

.drag-handle:focus {
    outline: 2px solid var(--color-focus, #3b82f6);
    outline-offset: 2px;
    border-radius: 4px;
}

.lock-indicator {
    padding: 0.25rem 0.5rem;
    font-size: 0.7rem;
    font-weight: 600;
    text-transform: uppercase;
    color: var(--color-primary, #3b82f6);
    background: var(--color-primary-subtle, #dbeafe);
    border-radius: 4px;
    margin-right: 0.5rem;
}

.battle-card-content {
    flex: 1;
    min-width: 0;
}

.battle-position {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 1.5rem;
    height: 1.5rem;
    font-size: 0.75rem;
    font-weight: 600;
    background: var(--color-bg-muted, #f3f4f6);
    border-radius: 50%;
    margin-right: 0.5rem;
}

.sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border: 0;
}

.empty-queue {
    color: var(--color-text-muted, #666);
    font-style: italic;
    padding: 1rem;
    text-align: center;
}
</style>

{# Sortable.js integration for drag-and-drop #}
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const sortableList = document.getElementById('sortable-battles');
    if (!sortableList) return;

    new Sortable(sortableList, {
        handle: '.drag-handle',
        filter: '.battle-locked',
        animation: 150,
        ghostClass: 'dragging',

        onEnd: function(evt) {
            const battleId = evt.item.dataset.battleId;
            const newPosition = evt.newIndex + 1; // 1-indexed

            // Don't allow moving to position 1 (locked)
            if (newPosition <= 1) {
                // Revert by triggering HTMX refresh
                htmx.trigger(sortableList.closest('#battle-queue'), 'htmx:trigger');
                return;
            }

            // Submit reorder via HTMX
            const form = document.createElement('form');
            form.innerHTML = `<input type="hidden" name="new_position" value="${newPosition}">`;

            htmx.ajax('POST', `/battles/${battleId}/reorder`, {
                values: { new_position: newPosition },
                target: '#battle-queue',
                swap: 'outerHTML'
            });

            // Announce to screen readers
            const status = document.getElementById('reorder-status');
            if (status) {
                status.textContent = `Battle moved to position ${newPosition}`;
            }
        }
    });

    // Keyboard support for reordering
    sortableList.addEventListener('keydown', function(e) {
        if (e.target.classList.contains('drag-handle')) {
            const card = e.target.closest('.battle-card');
            if (card.classList.contains('battle-locked')) return;

            const allCards = Array.from(sortableList.querySelectorAll('.battle-card:not(.battle-locked)'));
            const currentIndex = allCards.indexOf(card);

            if (e.key === 'ArrowUp' && currentIndex > 0) {
                e.preventDefault();
                const battleId = card.dataset.battleId;
                const newPosition = currentIndex + 1; // Move up = lower index, but position is 1-indexed and first is locked

                htmx.ajax('POST', `/battles/${battleId}/reorder`, {
                    values: { new_position: newPosition },
                    target: '#battle-queue',
                    swap: 'outerHTML'
                });
            } else if (e.key === 'ArrowDown' && currentIndex < allCards.length - 1) {
                e.preventDefault();
                const battleId = card.dataset.battleId;
                const newPosition = currentIndex + 3; // Move down

                htmx.ajax('POST', `/battles/${battleId}/reorder`, {
                    values: { new_position: newPosition },
                    target: '#battle-queue',
                    swap: 'outerHTML'
                });
            }
        }
    });
});
</script>
