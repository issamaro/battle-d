{% extends "base.html" %}

{% block title %}Battles{% if category %} - {{ category.name }}{% endif %} - Battle-D{% endblock %}

{% block header_title %}Battles{% if category %} - {{ category.name }}{% endif %}{% endblock %}

{% block content %}
<!-- Breadcrumb Navigation -->
<nav class="battle-breadcrumb" aria-label="Breadcrumb">
    <a href="/overview" class="breadcrumb-link">Overview</a>
    <span class="breadcrumb-separator" aria-hidden="true">/</span>
    <span class="breadcrumb-current" aria-current="page">Battles{% if category %} - {{ category.name }}{% endif %}</span>
</nav>

{% if category %}
<section>
    <h3>{{ category.name }}</h3>
    <p>{{ category.description or "No description" }}</p>
</section>
{% endif %}

<!-- Status Filter -->
<section>
    <h3 id="filter-heading">Filter by Status</h3>
    <div class="battle-status-filter" role="group" aria-labelledby="filter-heading">
        <a href="?category_id={{ category.id if category else '' }}"
           class="filter-chip {% if not status_filter %}filter-chip-active{% endif %}"
           aria-label="Show all battles"
           aria-current="{% if not status_filter %}true{% else %}false{% endif %}">
            All
        </a>
        <a href="?category_id={{ category.id if category else '' }}&status_filter=pending"
           class="filter-chip {% if status_filter == 'pending' %}filter-chip-active{% endif %}"
           aria-label="Show pending battles"
           aria-current="{% if status_filter == 'pending' %}true{% else %}false{% endif %}">
            Pending
        </a>
        <a href="?category_id={{ category.id if category else '' }}&status_filter=active"
           class="filter-chip {% if status_filter == 'active' %}filter-chip-active{% endif %}"
           aria-label="Show active battles"
           aria-current="{% if status_filter == 'active' %}true{% else %}false{% endif %}">
            Active
        </a>
        <a href="?category_id={{ category.id if category else '' }}&status_filter=completed"
           class="filter-chip {% if status_filter == 'completed' %}filter-chip-active{% endif %}"
           aria-label="Show completed battles"
           aria-current="{% if status_filter == 'completed' %}true{% else %}false{% endif %}">
            Completed
        </a>
    </div>
</section>

<!-- Battle List -->
<section id="battle-list">
    <h3>Battles</h3>
    {% if battles %}
        <div class="battle-grid"
             role="list"
             aria-label="Battle list"
             hx-get="/battles?category_id={{ category.id if category else '' }}{% if status_filter %}&status_filter={{ status_filter }}{% endif %}"
             hx-trigger="every 5s"
             hx-select=".battle-grid"
             hx-target="this"
             hx-swap="outerHTML">
            {% for battle in battles %}
            <article class="battle-card" role="listitem" id="battle-card-{{ battle.id }}">
                <div class="battle-card-header">
                    <h4 class="battle-card-title">{{ battle.phase.value|title }}</h4>
                    <span class="badge badge-{{ battle.status.value }}"
                          role="status"
                          aria-label="Battle status: {{ battle.status.value }}">
                        {{ battle.status.value|upper }}
                    </span>
                </div>

                <div class="battle-card-body">
                    <!-- Battle Identifier with Performer Names -->
                    <div class="battle-identifier" aria-label="Battle participants">
                        <span class="battle-performer-names">
                            {% for performer in battle.performers[:3] %}
                                {{ performer.dancer.dancer_name }}{% if not loop.last %}<span class="battle-vs-separator" aria-hidden="true">vs</span>{% endif %}
                            {% endfor %}
                            {% if battle.performers|length > 3 %}
                                <span class="battle-vs-separator" aria-hidden="true">+</span>{{ battle.performers|length - 3 }} more
                            {% endif %}
                        </span>
                    </div>

                    <!-- Battle Metadata -->
                    <div class="battle-meta">
                        <div class="battle-meta-item">
                            <span class="battle-meta-label">Phase:</span>
                            <span class="battle-meta-value">{{ battle.phase.value|title }}</span>
                        </div>
                        <div class="battle-meta-item">
                            <span class="battle-meta-label">Performers:</span>
                            <span class="battle-meta-value">{{ battle.performers|length }}</span>
                        </div>
                        {% if battle.status.value == 'completed' and battle.winner_id %}
                        <div class="battle-meta-item">
                            <span class="battle-meta-label">Winner:</span>
                            <span class="battle-meta-value" aria-label="Winner">
                                {% for performer in battle.performers %}
                                    {% if performer.id == battle.winner_id %}
                                        üèÜ {{ performer.dancer.dancer_name }}
                                    {% endif %}
                                {% endfor %}
                            </span>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <div class="battle-card-footer battle-actions">
                    <a href="/battles/{{ battle.id }}"
                       class="battle-action-btn battle-action-secondary"
                       aria-label="View details for {{ battle.phase.value }} battle">
                        View Details
                    </a>

                    {% if battle.status.value == 'pending' %}
                    <form action="/battles/{{ battle.id }}/start" method="post" style="display: inline;">
                        <button type="submit"
                                class="battle-action-btn battle-action-primary"
                                aria-label="Start {{ battle.phase.value }} battle">
                            Start Battle
                        </button>
                    </form>
                    {% elif battle.status.value == 'active' %}
                    <a href="/battles/{{ battle.id }}/encode"
                       class="battle-action-btn battle-action-primary"
                       aria-label="Encode result for {{ battle.phase.value }} battle">
                        Encode Result
                    </a>
                    {% endif %}
                </div>
            </article>
            {% endfor %}
        </div>

        <p aria-live="polite">
            <strong>Total Battles:</strong> {{ battles|length }}
        </p>
    {% else %}
        {% if status_filter %}
            {% set title = "No Battles Found" %}
            {% set message = 'No battles found with status "' ~ status_filter ~ '"' %}
            {% set icon = "üîç" %}
        {% elif not category %}
            {% set title = "No Category Selected" %}
            {% set message = "Please select a category to view battles" %}
            {% set icon = "‚öîÔ∏è" %}
        {% else %}
            {% set title = "No Battles Yet" %}
            {% set message = "Battles will be created when the tournament advances to the next phase" %}
            {% set icon = "‚öîÔ∏è" %}
        {% endif %}
        {% include "components/empty_state.html" %}
    {% endif %}
</section>
{% endblock %}
