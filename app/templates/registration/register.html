{% extends "base.html" %}

{% block title %}Register Dancers - {{ category.name }} - Battle-D{% endblock %}

{% block content %}
<link rel="stylesheet" href="/static/css/registration.css">

<div class="registration-header">
    <a href="/tournaments/{{ tournament.id }}">‚Üê Back to Tournament</a>
    <h2>{{ category.name }} {% if category.is_duo %}(Duo){% endif %}</h2>
    <p id="registration-status" class="registration-count">
        {% with registered_count=performers|length, ideal_count=category.performers_ideal * category.groups_ideal, minimum_required=category.performers_ideal %}
        {% include "registration/_registration_status.html" %}
        {% endwith %}
    </p>
</div>

<!-- Loading indicator -->
<div id="reg-loading" class="htmx-indicator" style="text-align: center; padding: 10px;">
    Loading...
</div>

{% if category.is_duo %}
<!-- DUO (2v2) REGISTRATION - Keep existing complex UI -->
<section>
    <article>
        <p>Duo categories require special registration. Search and select two dancers to form a duo.</p>
    </article>
</section>

<div class="registration-panels">
    <!-- Registered Duos -->
    <section class="panel panel-registered">
        <div class="panel-header">
            <h3>Registered Duos ({{ (performers|length) // 2 }})</h3>
        </div>
        <div class="panel-list">
            {% if performers %}
            <div class="performer-list">
                {% for performer in performers %}
                {% if performer.duo_partner %}
                <article class="performer-card duo-card">
                    <div class="performer-info">
                        <strong>{{ performer.dancer.blaze }} & {{ performer.duo_partner.dancer.blaze }}</strong>
                        <small>{{ performer.dancer.full_name }} + {{ performer.duo_partner.dancer.full_name }}</small>
                    </div>
                    <form method="post" action="/registration/{{ tournament.id }}/{{ category.id }}/unregister/{{ performer.id }}">
                        <button type="submit" class="btn-remove"
                                onclick="return confirm('Unregister this duo?')">
                            Remove Duo
                        </button>
                    </form>
                </article>
                {% endif %}
                {% endfor %}
            </div>
            {% else %}
            <div class="empty-message">
                <p>No duos registered yet.</p>
            </div>
            {% endif %}
        </div>
    </section>

    <!-- Duo Registration Form -->
    <section class="panel panel-available">
        <div class="panel-header">
            <h3>Register New Duo</h3>
        </div>
        <div class="duo-registration">
            <div class="duo-search-grid">
                <!-- Dancer 1 Search -->
                <div class="duo-dancer-search">
                    <h4>Dancer 1</h4>
                    <input type="text"
                           id="search-dancer1"
                           name="query"
                           placeholder="Search by blaze, name..."
                           hx-get="/registration/{{ tournament.id }}/{{ category.id }}/search-dancer"
                           hx-trigger="keyup changed delay:500ms"
                           hx-target="#dancer1-results"
                           hx-vals='{"dancer_number": 1}'>
                    <div id="dancer1-results" class="search-results">
                        <p class="hint">Start typing to search...</p>
                    </div>
                </div>

                <!-- Dancer 2 Search -->
                <div class="duo-dancer-search">
                    <h4>Dancer 2</h4>
                    <input type="text"
                           id="search-dancer2"
                           name="query"
                           placeholder="Search by blaze, name..."
                           hx-get="/registration/{{ tournament.id }}/{{ category.id }}/search-dancer"
                           hx-trigger="keyup changed delay:500ms"
                           hx-target="#dancer2-results"
                           hx-vals='{"dancer_number": 2}'>
                    <div id="dancer2-results" class="search-results">
                        <p class="hint">Start typing to search...</p>
                    </div>
                </div>
            </div>

            <!-- Selected Duo Summary -->
            <div id="duo-summary" class="duo-summary" style="display: none;">
                <h4>Selected Duo</h4>
                <p><strong>Dancer 1:</strong> <span id="selected-dancer1-name">-</span></p>
                <p><strong>Dancer 2:</strong> <span id="selected-dancer2-name">-</span></p>
                <form method="post" action="/registration/{{ tournament.id }}/{{ category.id }}/register-duo">
                    <input type="hidden" id="dancer1_id" name="dancer1_id" value="">
                    <input type="hidden" id="dancer2_id" name="dancer2_id" value="">
                    <div role="group">
                        <button type="submit">Register Duo</button>
                        <button type="button" class="secondary" onclick="clearDuoSelection()">Clear</button>
                    </div>
                </form>
            </div>
        </div>
    </section>
</div>

<script>
let selectedDancer1 = null;
let selectedDancer2 = null;

function selectDancer(dancerId, dancerName, dancerNumber) {
    if (dancerNumber === 1) {
        selectedDancer1 = {id: dancerId, name: dancerName};
        document.getElementById('dancer1_id').value = dancerId;
        document.getElementById('selected-dancer1-name').textContent = dancerName;
    } else {
        selectedDancer2 = {id: dancerId, name: dancerName};
        document.getElementById('dancer2_id').value = dancerId;
        document.getElementById('selected-dancer2-name').textContent = dancerName;
    }

    if (selectedDancer1 && selectedDancer2) {
        document.getElementById('duo-summary').style.display = 'block';
    }
}

function clearDuoSelection() {
    selectedDancer1 = null;
    selectedDancer2 = null;
    document.getElementById('dancer1_id').value = '';
    document.getElementById('dancer2_id').value = '';
    document.getElementById('selected-dancer1-name').textContent = '-';
    document.getElementById('selected-dancer2-name').textContent = '-';
    document.getElementById('duo-summary').style.display = 'none';
}
</script>

{% else %}
<!-- SOLO (1v1) REGISTRATION - Two-Panel Layout -->
<div class="registration-panels">
    <!-- Left: Available Dancers -->
    <section class="panel panel-available">
        <div class="panel-header">
            <h3>Available Dancers</h3>
            <input type="search"
                   name="q"
                   placeholder="Search by blaze, name, email..."
                   hx-get="/registration/{{ tournament.id }}/{{ category.id }}/available"
                   hx-trigger="keyup changed delay:300ms"
                   hx-target="#available-list"
                   hx-indicator="#reg-loading">
        </div>
        <div id="available-list" class="panel-list"
             hx-get="/registration/{{ tournament.id }}/{{ category.id }}/available"
             hx-trigger="load">
            <p class="hint">Loading dancers...</p>
        </div>
    </section>

    <!-- Right: Registered Dancers -->
    <section class="panel panel-registered">
        <div class="panel-header">
            <h3>Registered</h3>
        </div>
        <div id="registered-list" class="panel-list"
             hx-get="/registration/{{ tournament.id }}/{{ category.id }}/registered"
             hx-trigger="load">
            <p class="hint">Loading...</p>
        </div>
    </section>
</div>
{% endif %}

<section class="registration-footer">
    <p><small>Each dancer can only register in ONE category per tournament.</small></p>
    <a href="/dancers/create">+ Create New Dancer</a>
</section>
{% endblock %}
