{% extends "base.html" %}

{% block title %}Fix Tournament Configuration - Battle-D{% endblock %}

{% block content %}
<h2>⚠️ Data Integrity Issue Detected</h2>

<section class="alert alert-warning alert-titled">
    <h3>⚠️ MULTIPLE ACTIVE TOURNAMENTS FOUND</h3>
    <p>
        <strong>Data Integrity Violation:</strong> Multiple tournaments are currently in ACTIVE status.
        Only one tournament can be active at a time according to business rules.
    </p>
    <p>
        <strong>Select which tournament should remain active.</strong> All others will be automatically
        set to the correct status based on their current phase.
    </p>
</section>

<section>
    <h3>Active Tournaments ({{ active_tournaments|length }} found)</h3>

    <form method="post" action="/admin/tournaments/fix-active">
        <div class="table-wrapper">
            <table class="table" role="grid">
                <thead>
                    <tr>
                        <th>Keep Active?</th>
                        <th>Tournament Name</th>
                        <th>Created Date</th>
                        <th>Current Phase</th>
                        <th>Will Become</th>
                    </tr>
                </thead>
                <tbody>
                    {% for tournament in active_tournaments %}
                    <tr>
                        <td class="text-center">
                            <input
                                type="radio"
                                name="keep_active"
                                value="{{ tournament.id }}"
                                required
                            >
                        </td>
                        <td><strong>{{ tournament.name }}</strong></td>
                        <td>{{ tournament.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                        <td>
                            <span class="badge badge-active">
                                {{ tournament.phase.value|upper }}
                            </span>
                        </td>
                        <td>
                            {% if tournament.phase.value == 'registration' %}
                                <span class="badge badge-pending">
                                    CREATED
                                </span>
                                <small class="text-muted d-block mt-1">
                                    (not started yet)
                                </small>
                            {% elif tournament.phase.value == 'completed' %}
                                <span class="badge badge-pending">
                                    COMPLETED
                                </span>
                                <small class="text-muted d-block mt-1">
                                    (already finished)
                                </small>
                            {% else %}
                                <span class="badge badge-cancelled">
                                    CANCELLED
                                </span>
                                <small class="text-muted d-block mt-1">
                                    (stopped mid-tournament)
                                </small>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div class="alert alert-info alert-titled mt-5">
            <h4>ℹ️ How it works</h4>
            <p>
                Select which tournament should remain ACTIVE. All others will be automatically
                set to the correct status based on their phase:
            </p>
            <ul>
                <li><strong>REGISTRATION</strong> phase → <strong>CREATED</strong> (tournament hasn't started yet)</li>
                <li><strong>PRESELECTION/POOLS/FINALS</strong> → <strong>CANCELLED</strong> (in-progress tournament stopped)</li>
                <li><strong>COMPLETED</strong> phase → <strong>COMPLETED</strong> (tournament already finished)</li>
            </ul>
            <p class="alert-muted">
                This ensures phase and status remain consistent with business rules.
            </p>
        </div>

        <div class="form-actions">
            <button type="submit" class="btn btn-primary">
                Fix Tournament Configuration
            </button>
        </div>
    </form>

    <p class="mt-5">
        <a href="/auth/logout" role="button" class="btn btn-secondary">Logout (I need to think about this)</a>
    </p>
</section>
{% endblock %}
