{% extends "base.html" %}

{% block title %}{{ tournament.name }} - Battle-D{% endblock %}

{% block content %}
<h2>Tournament: {{ tournament.name }}</h2>

<section>
    <p><a href="/tournaments">&larr; Back to Tournaments</a></p>
</section>

<!-- Tournament Info Card - Use PicoCSS article -->
<article>
    <header>
        <h3>Tournament Information</h3>
    </header>

    <table>
        <tr>
            <td><strong>Status:</strong></td>
            <td>
                <span class="badge {% if tournament.status.value == 'active' %}badge-active{% elif tournament.status.value == 'cancelled' %}badge-warning{% else %}badge-pending{% endif %}">
                    {{ tournament.status.value|upper }}
                </span>
            </td>
        </tr>
        <tr>
            <td><strong>Phase:</strong></td>
            <td>
                <span class="badge badge-active">
                    {{ tournament.phase.value|upper }}
                </span>
            </td>
        </tr>
        <tr>
            <td><strong>Created:</strong></td>
            <td>{{ tournament.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
        </tr>
    </table>

    {% if current_user.is_mc or current_user.is_admin %}
    <footer>
        <a href="/event/{{ tournament.id }}" role="button" class="secondary">
            Event Mode
        </a>
    </footer>
    {% endif %}
</article>

<!-- Categories Section -->
<section>
    <h3>Categories</h3>

    {# BR-CAT-001: Only show Add Category button when tournament is CREATED #}
    {% if tournament.status.value == 'created' %}
    <p>
        <a href="/tournaments/{{ tournament.id }}/add-category" role="button">
            + Add Category
        </a>
    </p>
    {% endif %}

    {% if category_data %}
        <figure>
            <table role="grid">
                <thead>
                    <tr>
                        <th>Category Name</th>
                        <th>Type</th>
                        <th>Registered</th>
                        <th>Minimum Required</th>
                        <th>Ideal Capacity</th>
                        <th>Pools</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in category_data %}
                    {% set minimum_required = item.category.minimum_performers_required %}
                    {% set is_ready = item.performer_count >= minimum_required %}
                    <tr id="category-row-{{ item.category.id }}">
                        <td><strong>{{ item.category.name }}</strong></td>
                        <td>{{ item.category.category_type }}</td>
                        <td>
                            <span class="badge {% if is_ready %}badge-completed{% else %}badge-pending{% endif %}">
                                {{ item.performer_count }}
                            </span>
                        </td>
                        <td>{{ minimum_required }}</td>
                        <td>
                            {{ item.category.ideal_pool_capacity }}
                            <br>
                            <small>({{ item.category.performers_ideal }}/pool)</small>
                        </td>
                        <td>{{ item.category.groups_ideal }}</td>
                        <td>
                            <div class="btn-group">
                                <a href="/registration/{{ tournament.id }}/{{ item.category.id }}" class="btn btn-sm btn-secondary">
                                    Register
                                </a>
                                {% if tournament.phase.value == 'registration' %}
                                {# Modal trigger instead of hx-confirm (BR-FIX-003) #}
                                <button type="button"
                                        class="btn btn-sm btn-danger"
                                        onclick="document.getElementById('remove-category-{{ item.category.id }}').showModal()">
                                    Remove
                                </button>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </figure>

        <small>
            <strong>Legend:</strong>
            <span class="badge badge-completed">Green</span> = Ready to advance |
            <span class="badge badge-pending">Gray</span> = Need more performers
        </small>

        {# Include category removal modals (BR-FIX-003) #}
        {% if tournament.phase.value == 'registration' %}
            {% for item in category_data %}
                {% set modal_id = "remove-category-" ~ item.category.id %}
                {% set category = item.category %}
                {% set performer_count = item.performer_count %}
                {% set tournament_id = tournament.id %}
                {% include "components/category_remove_modal.html" %}
            {% endfor %}
        {% endif %}
    {% else %}
        {% set title = "No Categories Yet" %}
        {# BR-CAT-001: Only show Add Category action when tournament is CREATED #}
        {% if tournament.status.value == 'created' %}
            {% set message = "Add a category to get started with registration!" %}
            {% set action_url = "/tournaments/" ~ tournament.id ~ "/add-category" %}
            {% set action_text = "Add Category" %}
        {% else %}
            {% set message = "No categories were added to this tournament." %}
        {% endif %}
        {% set icon = "folder" %}
        {% include "components/empty_state.html" %}
    {% endif %}
</section>

{# Phase Advancement Section - Admin Only #}
{% if current_user.is_admin and tournament.phase.value == 'registration' %}
<section class="mt-6">
    <h3>Phase Advancement</h3>

    {% set all_ready = true %}
    {% for item in category_data %}
        {% if item.performer_count < item.category.minimum_performers_required %}
            {% set all_ready = false %}
        {% endif %}
    {% endfor %}

    {% if all_ready and category_data|length > 0 %}
    <div class="card">
        <div class="card-body">
            <p>All categories meet minimum requirements. You can advance to the next phase.</p>
            <button type="button"
                    class="btn btn-primary"
                    onclick="document.getElementById('phase-advance-modal').showModal()">
                Advance to Preselection â†’
            </button>
        </div>
    </div>
    {% else %}
    <div class="card">
        <div class="card-body">
            <div class="alert alert-warning">
                <strong>Cannot advance phase:</strong>
                {% if category_data|length == 0 %}
                    No categories have been added yet.
                {% else %}
                    Not all categories meet minimum performer requirements.
                {% endif %}
            </div>
        </div>
    </div>
    {% endif %}
</section>

{# Include Phase Advance Modal #}
{% set modal_tournament = tournament %}
{% set modal_category_data = category_data %}
{% include "components/phase_advance_modal.html" %}
{% endif %}
{% endblock %}
